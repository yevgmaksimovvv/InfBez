# Архитектура проекта после рефакторинга

## Обзор

Проект был полностью рефакторирован для следования принципам **Single Responsibility Principle** (SRP) и **Separation of Concerns** (SoC). Каждый модуль теперь имеет четко определенную ответственность.

## Структура Backend

```
backend/
├── core/                           # Ядро приложения
│   ├── database.py                # SQLAlchemy engine и сессии
│   ├── encryption.py              # Шифрование RSA ключей
│   └── security/                  # Модули безопасности (разделены)
│       ├── __init__.py
│       ├── password_security.py   # Хеширование паролей (Streebog)
│       ├── jwt_security.py        # JWT токены
│       └── otp_security.py        # OTP генерация и валидация
│
├── models/                         # ORM модели (разделены)
│   ├── __init__.py
│   ├── user.py                    # Модель User + UserRole
│   ├── rsa_keypair.py             # Модель RSAKeyPair
│   └── document.py                # Модель Document
│
├── schemas/                        # Pydantic схемы (новая папка)
│   ├── __init__.py
│   ├── auth_schemas.py            # RegisterRequest, LoginRequest, OAuthCallback
│   ├── crypto_schemas.py          # EncryptRequest, DecryptRequest, HashRequest
│   └── document_schemas.py        # CreateDocumentRequest
│
├── services/                       # Бизнес-логика (новые сервисы)
│   ├── __init__.py
│   ├── auth_service.py            # AuthService - регистрация, аутентификация
│   ├── kuznechik_service.py       # KuznechikService - шифрование Кузнечик
│   ├── rsa_service.py             # RSAService - RSA операции + управление ключами
│   ├── hash_service.py            # HashService - хеширование Streebog
│   ├── document_service.py        # DocumentService - документы + PDF генерация
│   └── email_service.py           # Email + OTP отправка
│
├── routers/                        # HTTP эндпоинты (тонкий слой)
│   ├── auth.py                    # Роутер аутентификации
│   ├── crypto.py                  # Роутер криптографии
│   ├── documents.py               # Роутер документов
│   └── users.py                   # Роутер пользователей
│
├── middleware/
│   └── rate_limit.py              # Rate limiting
│
├── config.py                       # Конфигурация из .env
├── dependencies.py                 # FastAPI зависимости
└── main.py                         # Инициализация FastAPI
```

---

## Ключевые изменения

### 1. Разделение `core/security.py` → `core/security/`

**Было:** God object с 5 разными ответственностями (144 строки)

**Стало:** 3 специализированных модуля
- `password_security.py` - только работа с паролями
- `jwt_security.py` - только JWT токены
- `otp_security.py` - только OTP коды

**Преимущества:**
- Легче тестировать каждый компонент отдельно
- Проще добавлять новые методы аутентификации
- Четкая изоляция ответственности

---

### 2. Разделение `models/user.py` → `models/`

**Было:** 3 модели в одном файле (77 строк)

**Стало:** 3 отдельных файла
- `user.py` - User + UserRole
- `rsa_keypair.py` - RSAKeyPair
- `document.py` - Document

**Преимущества:**
- Модели могут расти независимо
- Легче найти нужную модель
- Соответствует принципу единственной ответственности

---

### 3. Создание `schemas/` (новая папка)

**Было:** Pydantic модели смешаны с роутерами

**Стало:** Отдельная папка с категоризированными схемами
- `auth_schemas.py` - схемы аутентификации
- `crypto_schemas.py` - схемы криптографии
- `document_schemas.py` - схемы документов

**Преимущества:**
- Переиспользование схем
- Легче поддерживать валидацию
- Четкое разделение данных и логики

---

### 4. Создание `services/` (слой бизнес-логики)

**Было:** Вся логика в роутерах (383 строки в crypto.py!)

**Стало:** Специализированные сервисы

#### `KuznechikService` (159 строк)
Ответственность:
- Шифрование/расшифрование Кузнечик
- PKCS#7 padding
- Валидация размера текста

#### `RSAService` (180 строк)
Ответственность:
- RSA шифрование/расшифрование
- Управление ключами в БД
- Проверка лимитов пользователя

#### `HashService` (22 строки)
Ответственность:
- Хеширование Streebog-512

#### `AuthService` (93 строки)
Ответственность:
- Регистрация пользователей
- Аутентификация (пароль + OTP)
- Управление OTP

#### `DocumentService` (170 строк)
Ответственность:
- CRUD документов
- Генерация PDF
- Цифровая подпись (Streebog)
- Проверка прав доступа

**Преимущества:**
- Легко тестировать бизнес-логику без HTTP
- Возможность переиспользования в других местах
- Роутеры стали тонким слоем (50-100 строк вместо 300+)

---

### 5. Рефакторинг роутеров

#### `routers/crypto.py`
**Было:** 383 строки, 6+ ответственностей

**Стало:** 155 строк, только HTTP эндпоинты
- Делегирует всю логику сервисам
- Обрабатывает только HTTP запросы/ответы
- Логирование на уровне HTTP

#### `routers/auth.py`
**Было:** 181 строка, смешанная логика

**Стало:** 109 строк, тонкий HTTP слой
- Использует AuthService для всей логики
- Только валидация HTTP и обработка ошибок

#### `routers/documents.py`
**Было:** 211 строк, PDF генерация в роутере

**Стало:** 115 строк
- DocumentService отвечает за PDF
- Роутер только обрабатывает HTTP

---

## Принципы новой архитектуры

### 1. Single Responsibility Principle (SRP)
Каждый класс/модуль отвечает только за одну вещь:
- `KuznechikService` - только Кузнечик
- `RSAService` - только RSA
- `HashService` - только хеширование

### 2. Dependency Injection
Сервисы получают зависимости через параметры:
```python
def encrypt(self, text: str, user: User, db: Session)
```

### 3. Separation of Concerns
- **Роутеры** - HTTP эндпоинты
- **Сервисы** - бизнес-логика
- **Модели** - структура данных
- **Схемы** - валидация

### 4. Testability
Каждый сервис можно тестировать изолированно:
```python
def test_kuznechik_encrypt():
    service = KuznechikService()
    encrypted, key = service.encrypt("test")
    assert encrypted is not None
```

---

## Метрики улучшения

| Файл | Было (строк) | Стало (строк) | Изменение |
|------|--------------|---------------|-----------|
| `core/security.py` | 144 | Удален | Разделен на 3 файла |
| `routers/crypto.py` | 383 | 155 | -60% |
| `routers/auth.py` | 181 | 109 | -40% |
| `routers/documents.py` | 211 | 115 | -45% |
| `models/user.py` | 77 | 39 | -49% |

### Новые файлы
- 3 файла в `core/security/`
- 2 новых файла моделей
- 3 файла схем
- 5 файлов сервисов

### Итого
- **Было:** 996 строк в 5 больших файлах
- **Стало:** ~1200 строк в 20+ специализированных файлах
- **+20% кода, но -60% сложности каждого файла**

---

## Как добавить новый алгоритм шифрования

Благодаря новой архитектуре, добавление нового алгоритма очень просто:

1. Создать `backend/services/new_algorithm_service.py`
2. Реализовать класс `NewAlgorithmService` с методами `encrypt()` и `decrypt()`
3. Добавить новую схему в `schemas/crypto_schemas.py`
4. Обновить роутер `routers/crypto.py` для обработки нового алгоритма

**Не нужно:**
- Трогать другие сервисы
- Изменять модели или базу данных
- Переписывать существующую логику

---

## Преимущества новой архитектуры

### ✅ Модульность
Каждый компонент независим и заменяем

### ✅ Тестируемость
Сервисы легко тестировать без FastAPI

### ✅ Расширяемость
Добавление новых функций не ломает существующие

### ✅ Читаемость
Маленькие файлы с четкой ответственностью

### ✅ Поддерживаемость
Легко найти нужный код и исправить баги

### ✅ Переиспользование
Сервисы можно использовать в разных местах

---

## Следующие шаги (опционально)

1. **Добавить юнит-тесты** для каждого сервиса
2. **Создать интеграционные тесты** для роутеров
3. **Добавить dependency injection контейнер** (например, `dependency-injector`)
4. **Реализовать репозитории** для работы с БД (паттерн Repository)
5. **Добавить кэширование** в сервисы (Redis)

---

## Контакты

Если есть вопросы по архитектуре, смотри комментарии в коде или обратись к документации FastAPI.
